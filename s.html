<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AMETHYST</title>
  <meta name="description" content="Fire Browsing. Fire Games. Fire Freedom."/>
  <meta name="author" content="Le le"/>
  <meta name="publisher" content="Le le"/>
  <meta name="language" content="en"/>
  <meta http-equiv="Content-Language" content="en"/>
  <meta name="robots" content="index, follow"/>
  <meta name="theme-color" content="#9E49B3"/>
  <meta name="msapplication-TileColor" content="#9E49B3"/>
  <meta name="msapplication-TileImage" content="/image/logo.png"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="mobile-web-app-capable" content="yes"/>
  <meta property="og:type" content="website"/>
  <meta property="og:title" content="AMETHYST -"/>
  <meta property="og:description" content="Fire Browsing. Fire Games. Fire Freedom."/>
  <meta property="og:site_name" content="AMETHYST -"/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:image" content="/image/logo.png"/>
  <meta property="og:image:type" content="image/png"/>
  <meta property="og:image:width" content="512"/>
  <meta property="og:image:height" content="512"/>
  <meta name="twitter:card" content="summary_large_image"/>
  <meta name="twitter:title" content="AMETHYST"/>
  <meta name="twitter:description" content="Fire Browsing. Fire Games. Fire Freedom."/>
  <meta name="twitter:image" content="/image/logo.png"/>
  <link rel="apple-touch-icon" sizes="180x180" href="/image/logo.png"/>
  <link rel="icon" type="image/png" sizes="32x32" href="/image/logo.png"/>
  <link rel="icon" type="image/png" sizes="16x16" href="/image/logo.png"/>
  <meta name="color-scheme" content="dark light"/>
  <meta name="referrer" content="no-referrer-when-downgrade"/>
  <meta name="viewport-fit" content="cover"/>
  <meta name="theme" content="dark"/>
  <meta name="rating" content="general"/>
  <meta name="HandheldFriendly" content="true"/>
  <meta name="apple-mobile-web-app-title" content="AMETHYST"/>
  <link href="https://fonts.googleapis.com/css2?family=BBH+Bartle&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>

button, input[type="button"], input[type="submit"] {
  font-size: 1.1em;
  font-family: 'Orbitron', sans-serif;
  cursor: pointer;
  transition: all 0.2s ease-in-out;
  text-transform: uppercase;
}

button:hover {
  transform: scale(1.05);
}

input[type="text"], input[type="file"], input[type="password"], select {
  font-size: 1em;
  font-family: 'Orbitron', sans-serif;
}
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      background: #000000;
    }

    body {
      font-family: 'Poppins', Arial, sans-serif;
      color: var(--text);
      overflow: hidden;
      height: 100vh;
    }

    html::before {
      content: "";
      position: fixed;
      inset: 0;
      opacity: 0.18;
      pointer-events: none;
      z-index: -1;
    }

    :root {
      --animation-speed: 1;
      --transition-fast: 0.15s;
      --transition-medium: 0.3s;
      --transition-slow: 0.5s;
    }

    @media (prefers-reduced-motion: reduce) {
      :root {
        --animation-speed: 0.01;
        --transition-fast: 0.01s;
        --transition-medium: 0.01s;
        --transition-slow: 0.01s;
      }
      
      *,
      *::before,
      *::after {
        animation-duration: 0.01s !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01s !important;
      }
    }

    .browser-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      --x: 50%;
      --y: 50%;
      --glow-size: 300px;
      --glow-size-hover: 400px;
      --glow-strength: 0.35;
      animation: fadeIn calc(0.6s / var(--animation-speed)) ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .tab-bar {
      background: linear-gradient(to bottom, 
        color-mix(in srgb, var(--primary-accent) 8%, transparent),
        color-mix(in srgb, var(--surface) 35%, transparent) 50%,
        color-mix(in srgb, var(--primary-deep) 12%, transparent));
      background-color: color-mix(in srgb, var(--surface) 25%, transparent);
      backdrop-filter: blur(20px) saturate(160%);
      -webkit-backdrop-filter: blur(20px) saturate(160%);
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      display: flex;
      align-items: flex-end;
      padding: 8px 8px 0 8px;
      gap: 4px;
      overflow-x: auto;
      overflow-y: hidden;
      position: relative;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2), inset 0 0 0 1px rgba(255, 255, 255, 0.03);
      border-radius: 12px 12px 0 0;
      margin: 12px 12px 0 12px;
      animation: slideDown calc(0.5s / var(--animation-speed)) ease-out;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .tab-bar::-webkit-scrollbar { height: 0; }

    .tab {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: color-mix(in srgb, var(--surface) 40%, transparent);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius: 8px 8px 0 0;
      min-width: 180px;
      max-width: 240px;
      cursor: pointer;
      transition: all var(--transition-medium) cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid rgba(255, 255, 255, 0.04);
      border-bottom: none;
      position: relative;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      animation: tabSlideIn calc(0.3s / var(--animation-speed)) ease-out backwards;
    }

    @keyframes tabSlideIn {
      from { opacity: 0; transform: translateX(-10px) scale(0.95); }
      to { opacity: 1; transform: translateX(0) scale(1); }
    }

    .tab::before {
      content: "";
      position: absolute;
      inset: 2px;
      pointer-events: none;
      border-radius: 6px 6px 0 0;
      background: radial-gradient(
        var(--glow-size) circle at var(--x, 50%) var(--y, 50%),
        color-mix(in srgb, var(--primary-accent) 12%, transparent) 0%,
        color-mix(in srgb, var(--primary-accent) 6%, transparent) 30%,
        transparent 68%
      );
      opacity: 0;
      transition: opacity 140ms ease-out;
      z-index: 0;
    }

    .tab:hover {
      background: color-mix(in srgb, var(--surface) 60%, transparent);
      border-color: rgba(255, 255, 255, 0.08);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transform: translateY(-2px) scale(1.02);
    }

    .tab:hover::before { opacity: 0.5; }

    .tab.active {
      background: var(--surface);
      border-color: rgba(255, 255, 255, 0.1);
      box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1), inset 0 0 0 1px rgba(255, 255, 255, 0.05);
      margin-bottom: -1px;
    }

    .tab.active::before { opacity: 0.7; }

    .tab-favicon { width: 16px; height: 16px; flex-shrink: 0; z-index: 1; }
    .tab-title { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 13px; font-weight: 500; z-index: 1; }
    .tab-close { width: 18px; height: 18px; border-radius: 4px; border: none; background: transparent; color: var(--text); cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; opacity: 0.6; transition: all var(--transition-fast) cubic-bezier(0.68, -0.55, 0.265, 1.55); font-size: 18px; line-height: 1; z-index: 1; }
    .tab-close:hover { opacity: 1; background: color-mix(in srgb, var(--primary-accent) 20%, transparent); transform: scale(1.2) rotate(90deg); }

    .new-tab-btn { padding: 8px 12px; background: transparent; border: none; color: var(--text); cursor: pointer; border-radius: 8px 8px 0 0; font-size: 18px; display: flex; align-items: center; justify-content: center; opacity: 0.7; transition: all var(--transition-medium) cubic-bezier(0.68, -0.55, 0.265, 1.55); min-width: 36px; }
    .new-tab-btn:hover { opacity: 1; background: color-mix(in srgb, var(--surface) 40%, transparent); backdrop-filter: blur(12px); transform: scale(1.15) rotate(90deg); }
    .new-tab-btn:active { transform: scale(0.95) rotate(90deg); }

    .nav-bar {
      background: linear-gradient(to bottom, color-mix(in srgb, var(--primary-accent) 6%, transparent), color-mix(in srgb, var(--surface) 30%, transparent));
      background-color: color-mix(in srgb, var(--surface) 20%, transparent);
      backdrop-filter: blur(20px) saturate(160%);
      -webkit-backdrop-filter: blur(20px) saturate(160%);
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      padding: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.2), inset 0 0 0 1px rgba(255,255,255,0.03);
      margin: 0 12px;
      animation: slideInLeft calc(0.5s / var(--animation-speed)) ease-out calc(0.1s / var(--animation-speed)) backwards;
    }

    @keyframes slideInLeft {
      from { opacity: 0; transform: translateX(-30px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .nav-controls { display: flex; gap: 4px; }
    .nav-btn, .menu-btn {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.04);
      background: color-mix(in srgb, var(--surface) 40%, transparent);
      backdrop-filter: blur(8px);
      color: var(--text);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all var(--transition-fast) cubic-bezier(0.68, -0.55, 0.265, 1.55);
      position: relative;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    .address-bar-container {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 8px;
      background: color-mix(in srgb, var(--surface) 50%, transparent);
      backdrop-filter: blur(12px) saturate(140%);
      -webkit-backdrop-filter: blur(12px) saturate(140%);
      border-radius: 20px;
      padding: 6px 12px;
      border: 1px solid rgba(255,255,255,0.06);
      transition: all var(--transition-medium) cubic-bezier(0.4,0,0.2,1);
      position: relative;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1), inset 0 1px 2px rgba(255,255,255,0.03);
    }

    .address-bar-container:focus-within { transform: scale(1.01); }
    .address-bar { flex: 1; border: none; background: transparent; color: var(--text); font-size: 14px; outline: none; font-family: 'Poppins', Arial, sans-serif; }
    .address-bar::placeholder { color: var(--muted); }

    .content-area { flex: 1; position: relative; overflow: hidden; background: rgba(0,0,0,0); border-radius: 0 0 12px 12px; margin: 0 12px 12px 12px; }
    .proxy-frame { display: none; width: 100%; height: 100%; border: none; }
    .proxy-frame.active { display: block; }
    .loading-indicator { position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, var(--primary-deep), var(--primary-accent)); transform: scaleX(0); transform-origin: left; transition: transform 0.3s; display: none; z-index: 10; box-shadow: 0 0 8px var(--primary-shadow); }
    .loading-indicator.loading { display: block; animation: loading 2s ease-in-out infinite; }

    @keyframes loading {
      0% { transform: scaleX(0); opacity: 0.8; }
      50% { transform: scaleX(0.7); opacity: 1; }
      100% { transform: scaleX(1); opacity: 0.9; }
    }

    .welcome-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; padding: 40px; animation: fadeInScale calc(0.6s / var(--animation-speed)) ease-out calc(0.2s / var(--animation-speed)) backwards; }

    @keyframes fadeInScale {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

    .welcome-screen h1 {
      font-size: 64px;
      margin-bottom: 16px;
      background: linear-gradient(135deg, var(--primary-accent), var(--primary-deep), var(--primary-accent));
      background-size: 200% 100%;
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: 700;
      animation: gradientShift calc(3s / var(--animation-speed)) ease-in-out infinite;
    }

    @keyframes gradientShift {
      0%,100%{background-position:0% center;}
      50%{background-position:100% center;}
    }

    .welcome-screen p { font-size: 18px; color: var(--muted); margin-bottom: 32px; }

    .welcome-search-bar {
      width: 100%;
      max-width: 600px;
      margin-bottom: 32px;
      display: flex;
      align-items: center;
      gap: 12px;
      background: color-mix(in srgb, var(--surface) 50%, transparent);
      backdrop-filter: blur(16px) saturate(140%);
      -webkit-backdrop-filter: blur(16px) saturate(140%);
      border-radius: 24px;
      padding: 12px 20px;
      border: 1px solid rgba(255,255,255,0.06);
      transition: all 0.2s;
      box-shadow: 0 4px 16px rgba(0,0,0,0.15), inset 0 1px 2px rgba(255,255,255,0.03);
    }

    .welcome-search-bar:focus-within {
      background: color-mix(in srgb, var(--surface) 70%, transparent);
      border-color: var(--primary-accent);
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary-accent) 15%, transparent), 0 4px 16px rgba(0,0,0,0.2), inset 0 1px 2px rgba(255,255,255,0.03);
      transform: scale(1.02);
    }

    .welcome-search-input {
      flex: 1;
      background: transparent;
      border: none;
      color: var(--text);
      font-size: 16px;
      sans-serif;
      outline: none;
    }

    .welcome-search-input::placeholder { color: var(--muted); }

    .shortcuts {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 16px;
      max-width: 600px;
      width: 100%;
    }

    .shortcut {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 20px;
      background: color-mix(in srgb, var(--surface) 60%, transparent);
      backdrop-filter: blur(16px) saturate(140%);
      -webkit-backdrop-filter: blur(16px) saturate(140%);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 12px;
      cursor: pointer;
      transition: all var(--transition-medium) cubic-bezier(0.34,1.56,0.64,1);
      text-decoration: none;
      color: var(--text);
      position: relative;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15), inset 0 1px 2px rgba(255,255,255,0.03);
      animation: shortcutFadeIn calc(0.4s / var(--animation-speed)) ease-out backwards;
    }

    .shortcut:nth-child(1){animation-delay:calc(0.3s / var(--animation-speed));}
    .shortcut:nth-child(2){animation-delay:calc(0.35s / var(--animation-speed));}
    .shortcut:nth-child(3){animation-delay:calc(0.4s / var(--animation-speed));}
    .shortcut:nth-child(4){animation-delay:calc(0.45s / var(--animation-speed));}
    .shortcut:nth-child(5){animation-delay:calc(0.5s / var(--animation-speed));}

    @keyframes shortcutFadeIn {
      from { opacity:0; transform: translateY(20px) scale(0.9); }
      to { opacity:1; transform: translateY(0) scale(1); }
    }

    .shortcut img { width: 32px; height: 32px; object-fit: contain; }
    .shortcut span { font-size: 14px; font-weight: 500; }

    .btn {
      padding: 10px 20px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.06);
      background: color-mix(in srgb, var(--surface) 55%, transparent);
      backdrop-filter: blur(14px) saturate(150%);
      -webkit-backdrop-filter: blur(14px) saturate(150%);
      color: var(--text);
      font-size: 15px;
      cursor: pointer;
      transition: all var(--transition-medium) cubic-bezier(0.34,1.56,0.64,1);
      box-shadow: 0 4px 14px rgba(0,0,0,0.18), inset 0 1px 2px rgba(255,255,255,0.04);
    }

    .btn:hover {
      background: color-mix(in srgb, var(--surface) 75%, transparent);
      transform: scale(1.05);
      box-shadow: 0 6px 18px rgba(0,0,0,0.22);
    }

    .btn:active {
      transform: scale(0.96);
    }

    .input-box {
      width: 100%;
      padding: 12px 16px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.06);
      background: color-mix(in srgb, var(--surface) 55%, transparent);
      backdrop-filter: blur(14px) saturate(150%);
      -webkit-backdrop-filter: blur(14px) saturate(150%);
      color: var(--text);
      font-size: 15px;
      outline: none;
      transition: all var(--transition-medium) cubic-bezier(0.34,1.56,0.64,1);
      box-shadow: 0 4px 14px rgba(0,0,0,0.18), inset 0 1px 2px rgba(255,255,255,0.04);
    }

    .input-box:focus {
      background: color-mix(in srgb, var(--surface) 75%, transparent);
      border-color: var(--primary-accent);
      transform: scale(1.02);
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary-accent) 18%, transparent), 
                  0 6px 18px rgba(0,0,0,0.2), 
                  inset 0 1px 2px rgba(255,255,255,0.04);
    }

    .input-box::placeholder {
      color: var(--muted);
    }
    
</style>

</head>

<body>
  <div class="browser-container">
    <div class="tab-bar" id="tab-bar">
      <button class="new-tab-btn" onclick="createNewTab()" title="New tab">+</button>
    </div>

    <div class="nav-bar">
      <div class="nav-controls">
        <button class="nav-btn" id="back-btn" onclick="goBack()" title="Go back" disabled>‚óÑ</button>
        <button class="nav-btn" id="forward-btn" onclick="goForward()" title="Go forward" disabled>‚ñ∫</button>
        <button class="nav-btn" id="refresh-btn" onclick="refreshPage()" title="Refresh">‚Üª</button>
      </div>
      
      <form class="address-bar-container" id="address-form" onsubmit="return handleAddressSubmit(event)">
        <span class="address-bar-icon">üîç</span>
        <input type="text" class="address-bar" id="address-bar" placeholder="Search or enter URL" autocomplete="off" />
      </form>

    </div>

    <div class="content-area" id="content-area">
      <div class="loading-indicator" id="loading-indicator"></div>
      <div class="welcome-screen" id="welcome-screen">
        <h1>AMETHYST browser</h1>
        <form class="welcome-search-bar" onsubmit="return handleWelcomeSearch(event)">
          <span class="welcome-search-icon">üîç</span>
          <input type="text" class="welcome-search-input" id="welcome-search-input" placeholder="Search or enter URL" autocomplete="off" />
        </form>
      </div>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const tabs = document.getElementById('tab-bar');
      const navBar = document.querySelector('.nav-bar');
      function updateMousePosition(e, element) {
        const rect = element.getBoundingClientRect();
        const x = ((e.clientX - rect.left) / rect.width) * 100;
        const y = ((e.clientY - rect.top) / rect.height) * 100;
        element.style.setProperty('--x', x + "%");
        element.style.setProperty('--y', y + "%");
      }
      tabs.addEventListener('mousemove', function(e) {
        updateMousePosition(e, tabs);
        const tab = e.target.closest('.tab');
        if (tab) updateMousePosition(e, tab);
      });
      document.querySelectorAll('.nav-btn, .menu-btn').forEach(btn => {
        btn.addEventListener('mousemove', function(e) {
          updateMousePosition(e, btn);
        });
      });
      const addressBar = document.querySelector('.address-bar-container');
      addressBar.addEventListener('mousemove', function(e) {
        updateMousePosition(e, addressBar);
      });
      document.addEventListener('mousemove', function(e) {
        const shortcut = e.target.closest('.shortcut');
        if (shortcut) updateMousePosition(e, shortcut);
      });
    });
  </script>

<script>
"use strict";

let tabCounter = 0;
let activeTabId = null;
const searchEngineUrl = "https://duckduckgo.com/?q=%s";

function getFavicon(url) {
  try {
    const domain = new URL(url).hostname;
    return `https://www.google.com/s2/favicons?domain=${domain}&sz=32`;
  } catch (e) {
    return "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23888' d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z'/%3E%3C/svg%3E";
  }
}

function getProxyUrl(url) {
  if (typeof __uv$config !== 'undefined') {
    return __uv$config.prefix + __uv$config.encodeUrl(url);
  }
  return "/s/ultraviolet/" + encodeURIComponent(url);
}

function search(input, template) {
  try {
    return new URL(input).toString();
  } catch (err) {
  }

  try {
    const url = new URL(`http://${input}`);
    if (url.hostname.includes(".")) return url.toString();
  } catch (err) {

  }

  return template.replace("%s", encodeURIComponent(input));
}


function switchToTab(tabId) {

  document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
  document.querySelectorAll('.proxy-frame').forEach(frame => frame.classList.remove('active'));
  

  const selectedTab = document.getElementById(tabId);
  const selectedFrame = document.getElementById(`${tabId}-frame`);
  
  if (selectedTab) selectedTab.classList.add('active');
  if (selectedFrame) {
    selectedFrame.classList.add('active');
    activeTabId = tabId;
    

    if (selectedFrame.src && selectedFrame.src !== 'about:blank' && selectedFrame.src !== window.location.href) {

      document.getElementById('welcome-screen').style.display = 'none';
    } else {

      document.getElementById('welcome-screen').style.display = 'flex';
    }
  } else {

    document.getElementById('welcome-screen').style.display = 'flex';
  }
}


function closeTab(tabId) {
  const tab = document.getElementById(tabId);
  const frame = document.getElementById(`${tabId}-frame`);
  
  if (tab) tab.remove();
  if (frame) frame.remove();
  

  if (activeTabId === tabId) {
    const remainingTabs = document.querySelectorAll('.tab');
    if (remainingTabs.length > 0) {
      switchToTab(remainingTabs[0].id);
    } else {
      activeTabId = null;
      document.getElementById('welcome-screen').style.display = 'flex';
      document.getElementById('address-bar').value = '';
    }
  }
}


function createNewTab() {
  const tabId = `tab-${++tabCounter}`;
  const tabBar = document.getElementById('tab-bar');
  const newTabBtn = tabBar.querySelector('.new-tab-btn');
  

  const tab = document.createElement('div');
  tab.className = 'tab';
  tab.id = tabId;
  tab.innerHTML = `
    <img class="tab-favicon" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23888' d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z'/%3E%3C/svg%3E" alt="">
    <span class="tab-title">New Tab</span>
    <button class="tab-close" onclick="closeTab('${tabId}')">√ó</button>
  `;
  
  tab.onclick = function(e) {
    if (!e.target.classList.contains('tab-close')) {
      switchToTab(tabId);
    }
  };
  
  tabBar.insertBefore(tab, newTabBtn);
  

  const contentArea = document.getElementById('content-area');
  const iframe = document.createElement('iframe');
  iframe.className = 'proxy-frame';
  iframe.id = `${tabId}-frame`;
  iframe.sandbox = "allow-scripts allow-same-origin allow-forms allow-popups allow-popups-to-escape-sandbox allow-modals allow-downloads";
  iframe.allow = "fullscreen; geolocation; microphone; camera";
  
  iframe.onload = function() {
    hideLoading();
    try {
      if (iframe.contentDocument && iframe.contentDocument.title) {
        tab.querySelector('.tab-title').textContent = iframe.contentDocument.title || 'Untitled';
      }
    } catch (e) {

    }
    

    setupLinkInterception(iframe);
  };
  
  contentArea.appendChild(iframe);
  

  switchToTab(tabId);
  document.getElementById('address-bar').focus();
}


function openProxyPage(url) {
  registerSW().then(() => {
    const tabId = activeTabId || `tab-${++tabCounter}`;
    let tab = document.getElementById(tabId);
    let iframe = document.getElementById(`${tabId}-frame`);
    

    if (!tab) {
      const tabBar = document.getElementById('tab-bar');
      const newTabBtn = tabBar.querySelector('.new-tab-btn');
      
      tab = document.createElement('div');
      tab.className = 'tab';
      tab.id = tabId;
      tab.innerHTML = `
        <img class="tab-favicon" src="${getFavicon(url)}" alt="">
        <span class="tab-title">Loading...</span>
        <button class="tab-close" onclick="closeTab('${tabId}')">√ó</button>
      `;
      
      tab.onclick = function(e) {
        if (!e.target.classList.contains('tab-close')) {
          switchToTab(tabId);
        }
      };
      
      tabBar.insertBefore(tab, newTabBtn);
      
      const contentArea = document.getElementById('content-area');
      iframe = document.createElement('iframe');
      iframe.className = 'proxy-frame';
      iframe.id = `${tabId}-frame`;
      iframe.sandbox = "allow-scripts allow-same-origin allow-forms allow-popups allow-popups-to-escape-sandbox allow-modals allow-downloads";
      iframe.allow = "fullscreen; geolocation; microphone; camera";
      
      iframe.onload = function() {
        hideLoading();
        try {
          if (iframe.contentDocument && iframe.contentDocument.title) {
            tab.querySelector('.tab-title').textContent = iframe.contentDocument.title || 'Untitled';
          }
        } catch (e) {
          tab.querySelector('.tab-title').textContent = 'Untitled';
        }
        

        setupLinkInterception(iframe);
      };
      
      contentArea.appendChild(iframe);
      switchToTab(tabId);
    } else {

      tab.querySelector('.tab-title').textContent = 'Loading...';
      tab.querySelector('.tab-favicon').src = getFavicon(url);
    }
    
    showLoading();
    iframe.src = getProxyUrl(url);
    document.getElementById('address-bar').value = url;
    document.getElementById('welcome-screen').style.display = 'none';
  }).catch(err => {
    console.error('Failed to register service worker:', err);
    alert('Failed to initialize proxy. Please refresh the page.');
  });
}


function handleAddressSubmit(event) {
  event.preventDefault();
  const input = document.getElementById('address-bar').value.trim();
  if (input) {
    const url = search(input, searchEngineUrl);
    openProxyPage(url);
  }
  return false;
}


function goBack() {
  const iframe = document.querySelector('.proxy-frame.active');
  if (iframe && iframe.contentWindow) {
    try {
      iframe.contentWindow.history.back();
    } catch (e) {
      console.log('Cannot go back');
    }
  }
}

function goForward() {
  const iframe = document.querySelector('.proxy-frame.active');
  if (iframe && iframe.contentWindow) {
    try {
      iframe.contentWindow.history.forward();
    } catch (e) {
      console.log('Cannot go forward');
    }
  }
}

function refreshPage() {
  const iframe = document.querySelector('.proxy-frame.active');
  if (iframe) {
    showLoading();
    iframe.src = iframe.src;
  }
}


function setupLinkInterception(iframe) {
  try {
    if (!iframe.contentDocument) return;
    

    const script = iframe.contentDocument.createElement('script');
    script.textContent = `
      (function() {

        document.addEventListener('click', function(e) {
          const link = e.target.closest('a');
          if (!link) return;
          
          const target = link.getAttribute('target');
          const isMiddleClick = e.button === 1;
          const isCtrlClick = e.ctrlKey || e.metaKey;
          

          if (target === '_blank' || isMiddleClick || isCtrlClick) {
            e.preventDefault();
            e.stopPropagation();
            
            const href = link.href;
            if (href) {
              window.parent.postMessage({
                type: 'open-new-tab',
                url: href
              }, '*');
            }
          }
        }, true);
        

        document.addEventListener('mousedown', function(e) {
          if (e.button === 1) {
            const link = e.target.closest('a');
            if (link && link.href) {
              e.preventDefault();
            }
          }
        }, true);
      })();
    `;
    iframe.contentDocument.head.appendChild(script);
  } catch (e) {

    console.log('Cannot inject link interceptor due to CORS');
  }
}


window.addEventListener('message', function(event) {
  if (event.data && event.data.type === 'open-new-tab' && event.data.url) {

    const newTabId = `tab-${++tabCounter}`;
    const tabBar = document.getElementById('tab-bar');
    const newTabBtn = tabBar.querySelector('.new-tab-btn');
    
    const tab = document.createElement('div');
    tab.className = 'tab';
    tab.id = newTabId;
    tab.innerHTML = `
      <img class="tab-favicon" src="${getFavicon(event.data.url)}" alt="">
      <span class="tab-title">Loading...</span>
      <button class="tab-close" onclick="closeTab('${newTabId}')">√ó</button>
    `;
    
    tab.onclick = function(e) {
      if (!e.target.classList.contains('tab-close')) {
        switchToTab(newTabId);
      }
    };
    
    tabBar.insertBefore(tab, newTabBtn);
    
    const contentArea = document.getElementById('content-area');
    const iframe = document.createElement('iframe');
    iframe.className = 'proxy-frame';
    iframe.id = `${newTabId}-frame`;
    iframe.sandbox = "allow-scripts allow-same-origin allow-forms allow-popups allow-popups-to-escape-sandbox allow-modals allow-downloads";
    iframe.allow = "fullscreen; geolocation; microphone; camera";
    
    iframe.onload = function() {
      hideLoading();
      try {
        if (iframe.contentDocument && iframe.contentDocument.title) {
          tab.querySelector('.tab-title').textContent = iframe.contentDocument.title || 'Untitled';
        }
      } catch (e) {
        tab.querySelector('.tab-title').textContent = 'Untitled';
      }
      
      setupLinkInterception(iframe);
    };
    
    contentArea.appendChild(iframe);
    
    showLoading();
    iframe.src = getProxyUrl(event.data.url);
    

    switchToTab(newTabId);
  }
});


function handleWelcomeSearch(event) {
  event.preventDefault();
  const input = document.getElementById('welcome-search-input').value.trim();
  if (input) {
    const url = search(input, searchEngineUrl);
    openProxyPage(url);
    document.getElementById('welcome-search-input').value = '';
  }
  return false;
}


function showLoading() {
  document.getElementById('loading-indicator').classList.add('loading');
}

function hideLoading() {
  document.getElementById('loading-indicator').classList.remove('loading');
}


document.addEventListener('DOMContentLoaded', function() {
  console.log('Proxy browser loaded');
  

  createNewTab();
});

</script>
</body>
</html>
